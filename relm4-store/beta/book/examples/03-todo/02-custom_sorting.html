<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Custom sorting - relm4-store</title>


        <!-- Custom HTML head -->

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../01-birth.html"><strong aria-hidden="true">1.1.</strong> How the data stores came to life</a></li><li class="chapter-item expanded "><a href="../../02-goals.html"><strong aria-hidden="true">1.2.</strong> Goals</a></li><li class="chapter-item expanded "><a href="../../03-relm4-vs-store.html"><strong aria-hidden="true">1.3.</strong> relm4 vs store</a></li><li class="chapter-item expanded "><a href="../../04-application_architecture.html"><strong aria-hidden="true">1.4.</strong> Application architecture</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/index.html"><strong aria-hidden="true">2.</strong> Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/01-setup.html"><strong aria-hidden="true">2.1.</strong> Setup</a></li><li class="chapter-item expanded "><a href="../../examples/01-todo/index.html"><strong aria-hidden="true">2.2.</strong> Simple todo 1</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/01-todo/01-model.html"><strong aria-hidden="true">2.2.1.</strong> Model</a></li><li class="chapter-item expanded "><a href="../../examples/01-todo/02-store.html"><strong aria-hidden="true">2.2.2.</strong> Store</a></li><li class="chapter-item expanded "><a href="../../examples/01-todo/03-task_list.html"><strong aria-hidden="true">2.2.3.</strong> View - Task list</a></li><li class="chapter-item expanded "><a href="../../examples/01-todo/04-main_window.html"><strong aria-hidden="true">2.2.4.</strong> View - Main window</a></li><li class="chapter-item expanded "><a href="../../examples/01-todo/05-main.html"><strong aria-hidden="true">2.2.5.</strong> main</a></li><li class="chapter-item expanded "><a href="../../examples/01-todo/06-configuration.html"><strong aria-hidden="true">2.2.6.</strong> configuration</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/02-todo/index.html"><strong aria-hidden="true">2.3.</strong> Simple todo 2</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/02-todo/01-generate-tasks.html"><strong aria-hidden="true">2.3.1.</strong> Generating tasks</a></li><li class="chapter-item expanded "><a href="../../examples/02-todo/02-updating-store-view.html"><strong aria-hidden="true">2.3.2.</strong> Updating store view</a></li><li class="chapter-item expanded "><a href="../../examples/02-todo/03-updating_taks_list.html"><strong aria-hidden="true">2.3.3.</strong> Updating task list</a></li><li class="chapter-item expanded "><a href="../../examples/02-todo/04-configuration.html"><strong aria-hidden="true">2.3.4.</strong> configuration</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/03-todo/index.html"><strong aria-hidden="true">2.4.</strong> Simple todo 3</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/03-todo/01-ordering.html"><strong aria-hidden="true">2.4.1.</strong> Ordering</a></li><li class="chapter-item expanded "><a href="../../examples/03-todo/02-custom_sorting.html" class="active"><strong aria-hidden="true">2.4.2.</strong> Custom sorting</a></li><li class="chapter-item expanded "><a href="../../examples/03-todo/03-view.html"><strong aria-hidden="true">2.4.3.</strong> View</a></li><li class="chapter-item expanded "><a href="../../examples/03-todo/04-configuration.html"><strong aria-hidden="true">2.4.4.</strong> configuration</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/04-todo/index.html"><strong aria-hidden="true">2.5.</strong> Simple todo 4</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/04-todo/01-view.html"><strong aria-hidden="true">2.5.1.</strong> View</a></li><li class="chapter-item expanded "><a href="../../examples/04-todo/02-configuration.html"><strong aria-hidden="true">2.5.2.</strong> configuration</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../store/index.html"><strong aria-hidden="true">3.</strong> Store</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../store/01-id.html"><strong aria-hidden="true">3.1.</strong> Id</a></li></ol></li><li class="chapter-item expanded "><a href="../../releases/index.html"><strong aria-hidden="true">4.</strong> Releases</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../releases/0.1-beta.2.html"><strong aria-hidden="true">4.1.</strong> 0.1-beta.2</a></li><li class="chapter-item expanded "><a href="../../releases/0.1-beta.1.html"><strong aria-hidden="true">4.2.</strong> 0.1-beta.1</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">relm4-store</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="custom-sorting"><a class="header" href="#custom-sorting">Custom sorting</a></h1>
<p>In this example we will be working with natural order. This means we need to update the <code>Tasks</code> store. All changes will take place in the <code>store/tasks.rs</code>.</p>
<p>First we need to change our use statements so we can change backend to the <code>SortedInMemoryBackend</code> from</p>
<pre><code class="language-rust noplaypen">use backend_inmemory::InMemoryBackend;
use backend_inmemory::InMemoryBackendConfiguration;
use store::Store;

use crate::model::Task;
</code></pre>
<p>to</p>
<pre><code class="language-rust noplaypen">use backend_inmemory::SortedInMemoryBackend;
use backend_inmemory::SortedInMemoryBackendConfiguration;
use store::Sorter;
use store::Store;

use crate::model::Task;
</code></pre>
<p><code>SortedInMemoryBackend</code> gives an ability to change natural order of the elements in the store. <code>SortedInMemoryBackendConfiguration</code> is the trait describing
configuration of the sorted backend. It's expanded version of the <code>InMemoryBackendConfiguration</code> to also provide information about how elements should be ordered.
<code>Sorter</code> is the trait which implementation will decide what orders are available.</p>
<h2 id="implementing-sorter"><a class="header" href="#implementing-sorter">Implementing sorter</a></h2>
<p>This section is important. We will talk a lot about Rust and how to go around some of design decisions done by Rust developers.</p>
<p>In Rust you can implement <code>std::cmp::Ord</code> for your structure. This will define natural order of all instances of your structure. Now there is a problem what if there
is more then one natural order? For example sales transactions can be sorted by the date of creations, or they can be sorted by the amount in the month, or they can
be sorted by the customer and date. There is many many more ways to provide good and meaningful order to more complex values. Unfortunately standard library of Rust
doesn't allow such scenarios. So how we can solve it? There are two ways and both are in the terrible territory</p>
<ol>
<li>Break requirements of <code>std::cmp::Ord</code> implementation</li>
<li>Repeat the code</li>
</ol>
<p>Let's talk about first point, breaking <code>Ord</code>. To properly implement <code>Ord</code> you must define total order. But your implementation must be coffined to values provided by
the structure so either you need a way to update all the instances of your structure simultaneously so every two instances will be compared using same comparator and
constitute that way a total order or you end up with instances which can't be compared with each other in the safe way. Returning broken result from sorting is the
smallest issue here since the second choice can make some sorting algorithms fail into infinite loop. First option on the other hand is going to mess up your results
if you have more then one collection of your structures which needs to be in order. If you need to change order of the first collection and change the natural order
of your structure when you will add new element to your second collection you are screwed. So breaking <code>Ord</code> is bad.</p>
<p>Second choice is to use lambdas and write your own sorting strategy every time again and again. Repeating the code is bad that's truism. If your code needs to guarantee
the correct order of elements now you either end up writing your own wrapper around standard collections or repeatably write your sorting functions. If your sorting
is just a tiny bit more complex then comparing single field you will not like this idea. Searching for errors where by accident fields in order where swapped is no fun.</p>
<p><code>SortedInMemoryStore</code> is specialized collection which keeps ordering internal to the collection so it's not related to any data inside the sorted structure. So as long
as instance of <code>Sorter</code> constitutes the total order we can update order of elements just this in this store and it won't affect any other store of elements of the same
kind. Since it's relative to store we can implement as many sorting strategies as we like and swap them in the runtime.</p>
<h3 id="total-order"><a class="header" href="#total-order">Total order</a></h3>
<p>Until now I was total order this and total order that. So let's remind ourselves what it is. In simple words it means that for any two elements in the set you can
definitely say which one is smaller or wherever they are equal. In case of our <code>todo</code> application it means that for any two possible tasks (so not only ones we created,
but literally any possible tasks) we must provide an answer what is relationship between them.</p>
<p>If we would be talking about integers, or rational numbers, or real numbers, or texts that order is really natural. <code>1</code> is before <code>2</code>, <code>a</code> is before <code>b</code>, etc... Problem
arises when we start talking about more complex structures. For example complex numbers don't have this kind of natural order. It's possible to order them but it
requires providing a definition of how you would like to see them ordered. Examples can be:</p>
<ul>
<li>real part, imaginary part</li>
<li>imaginary part, real part</li>
<li>length, angle</li>
<li>angle, length</li>
</ul>
<p>And there is infinitely many more different orderings which are equally good. When you write your application the structures are often way more complex. So defining
good total order becomes harder and harder.</p>
<p>Now let's talk about math</p>
<ol>
<li>It's reflexive: <code>a &lt;= a</code></li>
<li>It's transitive: <code>If a &lt;= b and b &lt;= c then a &lt;= c</code></li>
<li>It's antisymmetric: <code>If a &lt;= b and b &lt;= a then a == b</code></li>
<li>It's total: For any <code>a</code> and <code>b</code> <code>a &lt;= b or b &lt;= a</code></li>
</ol>
<p><strong>Warning</strong> If you don't like the idea of being sad java programmer take this relationships seriously.</p>
<h3 id="implementation"><a class="header" href="#implementation">Implementation</a></h3>
<p>Let's stop talking and get to work</p>
<pre><code class="language-rust noplaypen">pub enum OrderTasksBy {
    Name{ascending: bool},
}

impl Sorter&lt;Task&gt; for OrderTasksBy {
    fn cmp(&amp;self, lhs: &amp;Task, rhs: &amp;Task) -&gt; std::cmp::Ordering {
        match self {
            OrderTasksBy::Name{ascending} =&gt; {
                if *ascending {
                    lhs.description.cmp(&amp;rhs.description)
                }
                else {
                    lhs.description.cmp(&amp;rhs.description).reverse()
                }
            },
        }
    }
}

pub type Tasks = Store&lt;SortedInMemoryBackend&lt;TasksBuilder&gt;&gt;;

pub struct TasksBuilder {}
</code></pre>
<p>As you see we've implemented <code>Sorter</code> for enumeration and not a structure. This way you can add the new ways of sorting as you see fit. Just remember to make sure that
for every case <code>cmp</code> method is total order.</p>
<p>Where is the issue in our implementation? Equality relationship. Two records are the same if they have a same id. But our implementation doesn't use that. If we would
be using it the total order would be broken. So as you can see inside of the store we are using two different definitions of what <code>equal</code> means.</p>
<p>The <code>SortedInMemoryBackend</code> is using <code>record id equality</code> to perform CRUD actions on record level. When we talk about order so which element is after which we use sorter
equality. That in itself can lead to the issues. What if I have a two instances of the record in the store one with the old value and second with new one?
<code>SortedInMemoryBackend</code> doesn't. So you are safe.</p>
<p>If we would implement some kind of store which keeps historic values of the record so you can do record based rollback it would add another level of thinking how to
handle all of that.</p>
<p>Any store backend implementation is a convenience tool but you must think and understand about how it works. Unfortunately at the current level of implementation
I don't see any way to make it one stop shop for you.</p>
<h2 id="backend"><a class="header" href="#backend">Backend</a></h2>
<p>Wherever we used <code>InMemoryBackend</code> or <code>InMemoryBackendConfiguration</code> earlier now we must use <code>SortedInMemoryBackend</code> and <code>SortedInMemoryBackendConfiguration</code>.</p>
<pre><code class="language-rust noplaypen">pub type Tasks = Store&lt;InMemoryBackend&lt;TasksBuilder&gt;&gt;;
</code></pre>
<p>becomes</p>
<pre><code class="language-rust noplaypen">pub type Tasks = Store&lt;SortedInMemoryBackend&lt;TasksBuilder&gt;&gt;;
</code></pre>
<p>and</p>
<pre><code class="language-rust noplaypen">impl InMemoryBackendConfiguration for TasksBuilder
</code></pre>
<p>becomes</p>
<pre><code class="language-rust noplaypen">impl SortedInMemoryBackendConfiguration for TasksBuilder
</code></pre>
<p>What's left is to update the implementation of the <code>SortedInMemoryBackendConfiguration</code> for <code>TaskBuilder</code></p>
<pre><code class="language-rust noplaypen">impl SortedInMemoryBackendConfiguration for TasksBuilder
{
    type Record = Task;
    type OrderBy = OrderTasksBy;

    fn initial_data() -&gt; Vec&lt;Self::Record&gt; {
        vec![
            Task::new(String::from(&quot;r&quot;), false),
            Task::new(String::from(&quot;f&quot;), false),
            Task::new(String::from(&quot;i&quot;), false),
            Task::new(String::from(&quot;c&quot;), false),
            Task::new(String::from(&quot;o&quot;), false),
            Task::new(String::from(&quot;y&quot;), false),
            Task::new(String::from(&quot;l&quot;), false),
            Task::new(String::from(&quot;u&quot;), false),
        ]
    }

    fn initial_order() -&gt; Self::OrderBy {
        OrderTasksBy::Name{ascending: true}
    }
}
</code></pre>
<p>First we've defined <code>OrderBy</code> type to be the implementation of the <code>Sorter</code>. This way our backend will know which sorter to use.</p>
<p>As you see I've reduced amount of records by creating them by hand as unordered bunch of tasks. When you open your application they will show up in ascending order.
Ease proof that we didn't make a mistake.</p>
<p>Last update is the <code>initial_order</code> method. We didn't use <code>Default</code> for the <code>OrderTaskBy</code> because there could be more then one instance of the <code>Tasks</code> store with
different configuration and different needs. Hard coding that into <code>Default</code> would be exactly what Rust designers did to make our life hard while implementing our own
version of the data store.</p>
<p>Whole code after this step can be found in examples <code>todo_3_sorted_store</code>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../examples/03-todo/01-ordering.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../examples/03-todo/03-view.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../examples/03-todo/01-ordering.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../examples/03-todo/03-view.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
