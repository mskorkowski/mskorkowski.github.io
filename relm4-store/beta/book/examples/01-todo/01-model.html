<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Model - relm4-store</title>


        <!-- Custom HTML head -->

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../01-birth.html"><strong aria-hidden="true">1.1.</strong> How the data stores came to life</a></li><li class="chapter-item expanded "><a href="../../02-goals.html"><strong aria-hidden="true">1.2.</strong> Goals</a></li><li class="chapter-item expanded "><a href="../../03-relm4-vs-store.html"><strong aria-hidden="true">1.3.</strong> relm4 vs store</a></li><li class="chapter-item expanded "><a href="../../04-application_architecture.html"><strong aria-hidden="true">1.4.</strong> Application architecture</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/index.html"><strong aria-hidden="true">2.</strong> Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/01-setup.html"><strong aria-hidden="true">2.1.</strong> Setup</a></li><li class="chapter-item expanded "><a href="../../examples/01-todo/index.html"><strong aria-hidden="true">2.2.</strong> Simple todo 1</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/01-todo/01-model.html" class="active"><strong aria-hidden="true">2.2.1.</strong> Model</a></li><li class="chapter-item expanded "><a href="../../examples/01-todo/02-store.html"><strong aria-hidden="true">2.2.2.</strong> Store</a></li><li class="chapter-item expanded "><a href="../../examples/01-todo/03-task_list.html"><strong aria-hidden="true">2.2.3.</strong> View - Task list</a></li><li class="chapter-item expanded "><a href="../../examples/01-todo/04-main_window.html"><strong aria-hidden="true">2.2.4.</strong> View - Main window</a></li><li class="chapter-item expanded "><a href="../../examples/01-todo/05-main.html"><strong aria-hidden="true">2.2.5.</strong> main</a></li><li class="chapter-item expanded "><a href="../../examples/01-todo/06-configuration.html"><strong aria-hidden="true">2.2.6.</strong> configuration</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/02-todo/index.html"><strong aria-hidden="true">2.3.</strong> Simple todo 2</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/02-todo/01-generate-tasks.html"><strong aria-hidden="true">2.3.1.</strong> Generating tasks</a></li><li class="chapter-item expanded "><a href="../../examples/02-todo/02-updating-store-view.html"><strong aria-hidden="true">2.3.2.</strong> Updating store view</a></li><li class="chapter-item expanded "><a href="../../examples/02-todo/03-updating_taks_list.html"><strong aria-hidden="true">2.3.3.</strong> Updating task list</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/03-todo/index.html"><strong aria-hidden="true">2.4.</strong> Simple todo 3</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/03-todo/01-ordering.html"><strong aria-hidden="true">2.4.1.</strong> Ordering</a></li><li class="chapter-item expanded "><a href="../../examples/03-todo/02-custom_sorting.html"><strong aria-hidden="true">2.4.2.</strong> Custom sorting</a></li><li class="chapter-item expanded "><a href="../../examples/03-todo/03-view.html"><strong aria-hidden="true">2.4.3.</strong> View</a></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">relm4-store</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="model"><a class="header" href="#model">Model</a></h1>
<p>We are writing simple todo list. So we need to talk about tasks!</p>
<p>Task will have the description and status wherever it's completed or not.</p>
<p>So let's start with it. Create a file <code>model/task.rs</code> and write there</p>
<pre><code class="language-rust noplaypen">use std::fmt::{self, Debug, Display, Formatter};

use record::{Id, Record, DefaultIdAllocator, TemporaryIdAllocator};

#[derive(Clone, Debug)]
pub struct Task {
    id: Id&lt;Task&gt;,
    pub description: String,
    pub completed: bool,
}

impl Task {
    pub fn new(description: String, completed: bool) -&gt; Self {
        Self{
            id: Id::new(),
            description,
            completed,
        }
    }
}

impl Record for Task {
    type Allocator = DefaultIdAllocator;
    fn get_id(&amp;self) -&gt; Id&lt;Task&gt; {
        self.id
    }

    fn set_permanent_id(
        &amp;mut self, 
        value: &lt;Self::Allocator as TemporaryIdAllocator&gt;::Type
    ) -&gt; Result&lt;(), record::IdentityError&gt; {
        self.id = Id::from(value);
        Ok( () )
    }
}
</code></pre>
<p>This is minimal implementation for record. It consist of</p>
<ol>
<li>Definition of <code>Task</code> structure</li>
<li>Implementation for <code>Task</code> which provides method <code>new</code>.</li>
<li>Implementation of <code>record::Record</code> (<code>relm4_store_record::Record</code>)</li>
</ol>
<h2 id="task-structure"><a class="header" href="#task-structure"><code>Task</code> structure</a></h2>
<p>First we defined structure <code>Task</code>. It has a three fields. First is an <code>id</code>. This filed is used to identify the record in the store. This <code>id</code> must be stable during whole application execution. Later we have a description. It will contain the description of the task. At the end there is boolean flag which will let us know if the task has been completed or not.</p>
<p>Task derives two traits <code>Clone</code> and <code>Debug</code>. <code>Debug</code> is obvious. <code>Clone</code> is consequence of what <code>Record</code> is. Since you can save a record in the database it's equivalent of <code>Clone</code>. What's more without <code>Clone</code> it would be hard to reason about multiple views showing same record. It also allows to escape the lifetime boundary issues. Store is a collection of records. So whatever you will place there should have <code>'static</code> lifetime. Now let's think about keeping references to the records with <code>'static</code> lifetime which are being removed while application is being run. It sounds like going against what `'static' is. It isn't but requires so many lifetime annotations and makes code way overcomplicated.</p>
<h2 id="implementation-of-task"><a class="header" href="#implementation-of-task">Implementation of <code>Task</code></a></h2>
<p>As good practice I strongly suggest</p>
<ol>
<li>That you implement <code>new</code> for your business model structures. <code>new</code> should return really &quot;new&quot; instance so identifier should be set to <code>Id::New</code>.</li>
<li>In case you need to recreate an instance I would suggest using <code>from</code> method.</li>
</ol>
<p>It's related to the expected behavior of implementations of <code>Record</code>. Two instances of the business model are expected to represent the same value if their identifier is equal and not when internals are in the same state. You might think about <code>Record</code> as photograph of the business state at some point of time. You can have multiple photos of the <code>Record</code> but it's up to you to tell which is newer and which is older.</p>
<p>We can end our business modelling session now, except I like to add some pretty printing abilities to my business model classes. It's alway useful to be able to println them to see what happens.</p>
<pre><code class="language-rust noplaypen">impl Display for Task {
    fn fmt(&amp;self, f: &amp;mut Formatter&lt;'_&gt;) -&gt; fmt::Result {
        let completed = if self.completed {'x'} else {' '};
        f.write_str(&amp;format!(&quot;[{}] {}&quot;, completed, self.description))
    }
}
</code></pre>
<h2 id="implementation-of-recordrecord-for-task"><a class="header" href="#implementation-of-recordrecord-for-task">Implementation of <code>record::Record</code> for <code>Task</code></a></h2>
<p>Here is how we implemented the Record structure.</p>
<pre><code class="language-rust noplaypen">impl Record for Task {
    type Allocator = DefaultIdAllocator;
    fn get_id(&amp;self) -&gt; Id&lt;Task&gt; {
        self.id
    }

    fn set_permanent_id(
        &amp;mut self, 
        value: &lt;Self::Allocator as TemporaryIdAllocator&gt;::Type
    ) -&gt; Result&lt;(), record::IdentityError&gt; {
        self.id = Id::from(value);
        Ok( () )
    }
}
</code></pre>
<p>There are two methods and one type defined there. Method <code>get_id</code> is rather self explanatory. It returns current value of record identifier which we discussed in <code>Task structure</code> section. Method <code>set_permanent_id</code> overrides current value of id with new stable final version of identifier.</p>
<p>It's responsibility of the data store and backend to track down this information and propagate it. Why would you need something like that? The scenario I was solving for myself is &quot;how application should behave in presence of slow backend&quot;.</p>
<p>Without this feature when I commit a record to the slow backend I need to wait for the backend to respond with information about saving the record and I under which this record was saved before I can safely show it to user. Other method would be to track down which records are committed and which not. This might involve things like remembering that record without id at the 5th position of some list is the one which should be updated when 2nd http request is successful. It sound painful. Implementing it definitely is. Even if we assume you can do it bug free. Write it down 3 times for slightly different scenarios. So how did we solve it then? By making it data definition problem.</p>
<ol>
<li>Id must be unique. Two instances of the <code>Task</code> are considered to represent same record at maybe different point of time if their id is equal</li>
<li>In scope of the application, you must be able to return new unique id's during whole application lifetime. This allows you to provide temporary id's which are unique in currently running application. It doesn't matter if two running applications provide same unique id because when records from other application will be visible to this application only after being committed to the backend (for example database) which in turn would make them contain permanent id instead of temporary one. So this application will never see temporary id of other application</li>
<li>You are not allowed to keep copy of records with non permanent id. In most cases it's not an issue. Since after you create a record anc commit it to the database you don't really have a reason to keep copy of it. If for some reason you must keep the record around you are responsible for tracking this information</li>
<li>Only backend is allowed to call <code>set_permanent_id</code></li>
</ol>
<p>I'm going to elaborate little bit more about 4th point. To make it clear how bad it's to call it outside of the backend.</p>
<p>Let's assume you have a record like that</p>
<pre><code class="language-rust noplaypen">struct User {
    id: Id&lt;User&gt;,
    pub name: String,
}

impl Record for User {
    type Allocator = UserIdAllocator;

    fn get_id(&amp;self) -&gt; Id&lt;Task&gt; {
        self.id
    }

    fn set_permanent_id(
        &amp;mut self, 
        value: &lt;Self::Allocator as TemporaryIdAllocator&gt;::Type
    ) -&gt; Result&lt;(), record::IdentityError&gt; {
        self.id = Id::from(value);
        Ok( () )
    }
}
</code></pre>
<p>Somewhere in the code you've created a code like this:</p>
<pre><code class="language-rust noplaypen">fn new_user_from(mut u: User) -&gt; User {
    let id = UserIdAllocator::getId();
    u.set_permanent_id()
}
</code></pre>
<p>You compile and test your application. Everything works.</p>
<p>Now few request later you change the user definition:</p>
<pre><code class="language-rust noplaypen">struct User {
    id: Id&lt;User&gt;,
    pub name: String,
    // must be unique across all users
    pub unique_email: String,
}
</code></pre>
<p>Your code still compiles. But now anytime you invoke the <code>new_user_from</code> you produce a value which breaks your business model a little bit. If you are not really careful with your tests this error might live in your code base for very long time.</p>
<p>I've seen bugs similar to this one living in the production systems for years. Fixing them afterwards is at least problematic and more often impossible.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../examples/01-todo/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../examples/01-todo/02-store.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../examples/01-todo/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../examples/01-todo/02-store.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
