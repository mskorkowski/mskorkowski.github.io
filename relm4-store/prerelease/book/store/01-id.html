<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Id - relm4-store</title>


        <!-- Custom HTML head -->

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../01-birth.html"><strong aria-hidden="true">1.1.</strong> How the data stores came to life</a></li><li class="chapter-item expanded "><a href="../02-goals.html"><strong aria-hidden="true">1.2.</strong> Goals</a></li><li class="chapter-item expanded "><a href="../03-relm4-vs-store.html"><strong aria-hidden="true">1.3.</strong> relm4 vs store</a></li><li class="chapter-item expanded "><a href="../04-application_architecture.html"><strong aria-hidden="true">1.4.</strong> Application architecture</a></li></ol></li><li class="chapter-item expanded "><a href="../examples/index.html"><strong aria-hidden="true">2.</strong> Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/01-setup.html"><strong aria-hidden="true">2.1.</strong> Setup</a></li><li class="chapter-item expanded "><a href="../examples/01-todo/index.html"><strong aria-hidden="true">2.2.</strong> Simple todo 1</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/01-todo/01-model.html"><strong aria-hidden="true">2.2.1.</strong> Model</a></li><li class="chapter-item expanded "><a href="../examples/01-todo/02-store.html"><strong aria-hidden="true">2.2.2.</strong> Store</a></li><li class="chapter-item expanded "><a href="../examples/01-todo/03-task_list.html"><strong aria-hidden="true">2.2.3.</strong> View - Task list</a></li><li class="chapter-item expanded "><a href="../examples/01-todo/04-main_window.html"><strong aria-hidden="true">2.2.4.</strong> View - Main window</a></li><li class="chapter-item expanded "><a href="../examples/01-todo/05-main.html"><strong aria-hidden="true">2.2.5.</strong> main</a></li><li class="chapter-item expanded "><a href="../examples/01-todo/06-configuration.html"><strong aria-hidden="true">2.2.6.</strong> configuration</a></li></ol></li><li class="chapter-item expanded "><a href="../examples/02-todo/index.html"><strong aria-hidden="true">2.3.</strong> Simple todo 2</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/02-todo/01-generate-tasks.html"><strong aria-hidden="true">2.3.1.</strong> Generating tasks</a></li><li class="chapter-item expanded "><a href="../examples/02-todo/02-updating-store-view.html"><strong aria-hidden="true">2.3.2.</strong> Updating store view</a></li><li class="chapter-item expanded "><a href="../examples/02-todo/03-updating_taks_list.html"><strong aria-hidden="true">2.3.3.</strong> Updating task list</a></li><li class="chapter-item expanded "><a href="../examples/02-todo/04-configuration.html"><strong aria-hidden="true">2.3.4.</strong> configuration</a></li></ol></li><li class="chapter-item expanded "><a href="../examples/03-todo/index.html"><strong aria-hidden="true">2.4.</strong> Simple todo 3</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/03-todo/01-ordering.html"><strong aria-hidden="true">2.4.1.</strong> Ordering</a></li><li class="chapter-item expanded "><a href="../examples/03-todo/02-custom_sorting.html"><strong aria-hidden="true">2.4.2.</strong> Custom sorting</a></li><li class="chapter-item expanded "><a href="../examples/03-todo/03-view.html"><strong aria-hidden="true">2.4.3.</strong> View</a></li><li class="chapter-item expanded "><a href="../examples/03-todo/04-configuration.html"><strong aria-hidden="true">2.4.4.</strong> configuration</a></li></ol></li><li class="chapter-item expanded "><a href="../examples/04-todo/index.html"><strong aria-hidden="true">2.5.</strong> Simple todo 4</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/04-todo/01-view.html"><strong aria-hidden="true">2.5.1.</strong> View</a></li><li class="chapter-item expanded "><a href="../examples/04-todo/02-configuration.html"><strong aria-hidden="true">2.5.2.</strong> configuration</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../store/index.html"><strong aria-hidden="true">3.</strong> Storenomicon</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../store/01-id.html" class="active"><strong aria-hidden="true">3.1.</strong> Id</a></li></ol></li><li class="chapter-item expanded "><a href="../releases/index.html"><strong aria-hidden="true">4.</strong> Releases</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../releases/0.1-beta.3.html"><strong aria-hidden="true">4.1.</strong> 0.1-beta.3</a></li><li class="chapter-item expanded "><a href="../releases/0.1-beta.2.html"><strong aria-hidden="true">4.2.</strong> 0.1-beta.2</a></li><li class="chapter-item expanded "><a href="../releases/0.1-beta.1.html"><strong aria-hidden="true">4.3.</strong> 0.1-beta.1</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">relm4-store</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="id"><a class="header" href="#id">Id</a></h1>
<h2 id="status"><a class="header" href="#status">Status</a></h2>
<p>This part of <code>relm4-store</code> is rather set in stone. I don't expect any changes here.</p>
<h2 id="what-it-is"><a class="header" href="#what-it-is">What it is?</a></h2>
<p>Id is a value which uniquely identifies the record. In our case it's about record in the store. If your store holds records from database, you can reuse the database id.</p>
<h2 id="application-vs-database"><a class="header" href="#application-vs-database">Application vs database</a></h2>
<p>Let's talk a bit about records lifetime. If we would talk about the record from database point of view, you create a record by inserting all the data required and in most cases db somehow generates id for you. Every database I've worked with had some way to give unique id to the new record. So database doesn't need to deal with records which can't be identified by the key.</p>
<p>On the other hand your application first creates a record. Now you need to do two things at the same time</p>
<ol>
<li>Show the record to the user</li>
<li>Persist record in the storage</li>
</ol>
<p>If you show it before persisting then you send id which was generated by the database to all places where your record is shown so database and your application don't diverge. If you first persist and later show the record to the user it might lead to unresponsive application since user can be waiting for db instead of working.</p>
<h2 id="id-structure"><a class="header" href="#id-structure">Id structure</a></h2>
<p><code>relm4-store-record</code> separates id into two concepts</p>
<ul>
<li>Memory representation</li>
<li>Id state</li>
</ul>
<h3 id="memory-representation"><a class="header" href="#memory-representation">Memory representation</a></h3>
<p><code>relm4-store</code> gives you freedom how your id is structured in the memory. You can use <code>usize</code>, or <code>Uuid</code>,  or <code>i32</code>, or your custom structure. Memory representation must implement</p>
<ul>
<li><code>Copy</code></li>
<li><code>PartialEq</code></li>
<li><code>Eq</code></li>
<li><code>std::hash::Hash</code></li>
<li><code>std::fmt::Debug</code></li>
</ul>
<h4 id="partialeq-and-eq"><a class="header" href="#partialeq-and-eq"><code>PartialEq</code> and <code>Eq</code></a></h4>
<p><code>PartialEq</code> and <code>Eq</code> are required so we can tell wherever given one instance of the id is equal to other so we can distinguish if we talk about the different instance of the same record or not.</p>
<p>Example:</p>
<blockquote>
<p>You would like to mark the task in the todo application as complete. You pull the record from the store. Update the complete field. Now you send it back to the store with new value. But store returned a copy of a task and not a mutable reference. Now inside of the store implementation we need to find the original task and replace it with a new value. To do so we use id.</p>
</blockquote>
<h4 id="hash"><a class="header" href="#hash"><code>Hash</code></a></h4>
<p><code>Hash</code> is required because there is no order which can be defined on id and we somehow need to be able to create a mapping <code>id -&gt; record</code> and this gives us access to two excellent data structures <code>HashMap</code> and <code>HashSet</code>.</p>
<h4 id="copy"><a class="header" href="#copy"><code>Copy</code></a></h4>
<p>In general case record is many times larger then id. If we would keep ordered vector of records any shuffling operation would cause a massive amount of memory operations related to cloning records. On the other hand id is small and it's size should be perfectly known which makes memory copy super efficient operation.</p>
<h4 id="debug"><a class="header" href="#debug"><code>Debug</code></a></h4>
<p>If something goes wrong <code>relm4-store</code> will report an issue using record id. Since id is unique it should give you enough information about which record caused an issue.</p>
<h4 id="implementing-memory-representation"><a class="header" href="#implementing-memory-representation">Implementing memory representation</a></h4>
<p>To let <code>relm4-store</code> what is memory representation of your id you must implement <code>relm4-store-record::TemporaryIdAllocator</code> trait. It's defined as</p>
<pre><code class="language-rust noplaypen">pub trait TemporaryIdAllocator: Clone + Debug {
    /// Type of values on which `Id` is based of
    /// 
    /// This type defines memory representation of the id for the record
    type Type: Copy + PartialEq + Hash + Eq + std::fmt::Debug;
    /// Returns value of new **temporary** id
    /// 
    /// Every call must return new different value otherwise it's possible to have a conflict which could end up
    /// with data loss
    fn new_id() -&gt; Self::Type;
}
</code></pre>
<p>Type defines the memory layout of your id and all of the requirements mentioned before. Now lets go to the hard part, <code>new_id</code> method. Why it's hard? In single execution of your application every time you call it it must return unique value. If you call it twice to different values. You call it from another thread it returns different value. Wherever you call it in your application it must return different value each time and to make it worse only state it has at it's disposal is global one. In <code>C</code> there is <code>rand()</code> function. There are a lot of similarities in expectations about how <code>new_id</code> and <code>rand</code> works.</p>
<p>Until now we've focused on why it's hard to write <code>new_id</code>. Now let's talk about thinks that makes it easier for you. The most important part is, that it must return value which is unique only for given execution of the application. If you run your application twice it's not expected that values don't duplicate in such a case. It's expected that
it will return values proper for <code>Id::New</code>. They might be illegal for <code>Id::Permanent</code>.</p>
<h4 id="provided-id-allocators"><a class="header" href="#provided-id-allocators">Provided id allocators</a></h4>
<p>This is a list of id allocators provided by the <code>relm4-store</code> out of the box</p>
<table><thead><tr><th align="left">Allocator name</th><th align="left">Memory representation</th><th align="left">Notes</th></tr></thead><tbody>
<tr><td align="left">UuidAllocator</td><td align="left">uuid::Uuid</td><td align="left"></td></tr>
<tr><td align="left">DefaultIdAllocator</td><td align="left">uuid::Uuid</td><td align="left">Type alias to UuidAllocator</td></tr>
</tbody></table>
<p>Uuid was chosen as default since it's easy to implement and provides much better guarantees on uniqueness of the id then required. <code>UuidAllocator::new_id</code> returns random v4 uuid based on operating system RNG as the source of random bytes.</p>
<h4 id="why-there-is-no-allocator-for-i32-u32-i64-u64"><a class="header" href="#why-there-is-no-allocator-for-i32-u32-i64-u64">Why there is no allocator for i32, u32, i64, u64</a></h4>
<p>I'll discuss it based on <code>i32</code> example. All other allocators follows the same logic so if you replace <code>i32</code> in this section with any other value arguments will still hold.</p>
<p>To return different values for each <code>new_id</code> call we need to hold a counter somewhere in global scope. Let's use <code>AtomicI32</code> value to do that. Now if we only use this allocator
once in our application that's fine. Since id's will be given proper values. If you use it for two kinds of records the <code>new_id</code> requirements are still kept since they are unique in scope of two stores and not just one but is it valid in your application logic? Do you expect generated id's to keep an order? Or maybe you need them unique but random
so they are not predictable for security reasons?</p>
<p>There is a lot of decisions to make when you choose your temporary id allocator, so we've given up on implementing allocators requiring global state. In examples there is one which will show how to implement i32 id allocator.</p>
<h4 id="examples"><a class="header" href="#examples">Examples</a></h4>
<p>In <code>relm4-store-examples</code> crate you can find following examples showing custom memory representations for id's</p>
<table><thead><tr><th align="left">Example name</th><th align="left">Description</th></tr></thead><tbody>
<tr><td align="left">24_char_id_allocator</td><td align="left">Shows how to implement an id which consist of 24 characters, both for new and permanent ids</td></tr>
<tr><td align="left">id_allocator_with_different_types_for_new_and_permanent</td><td align="left">Shows how to implement an id which has different memory representation for new and permanent id's</td></tr>
<tr><td align="left">i32_allocator</td><td align="left">Shows how to implement allocator returning consecutive <code>i32</code> values</td></tr>
</tbody></table>
<h3 id="id-state"><a class="header" href="#id-state">Id state</a></h3>
<p>This part is provided for you by the <code>relm4-store</code> as <code>relm4-store-record::Id</code> enum. It has two variants <code>New</code> and <code>Permanent</code>. <code>New</code> is for records which has not been persisted. <code>Permanent</code> is for records which were.</p>
<p>Definition of the <code>relm4-store-record::Id</code></p>
<pre><code class="language-rust noplaypen">pub enum Id&lt;T&gt; 
where
    T: ?Sized + Record,
{
    /// Id for records which were not committed yet to store
    New{
        /// Value of the id
        value: &lt;T::Allocator as TemporaryIdAllocator&gt;::Type,
    },
    /// Id for records which are persisted already
    /// 
    /// What persisted means depends on the store.
    Permanent {
        /// Value of the id
        value: &lt;T::Allocator as TemporaryIdAllocator&gt;::Type,
    }
}
</code></pre>
<p>Persistance of the record is something which depends on the store/backend implementation. Some backends might consider persistance to be at the moment of inserting a data into the store. Some when remote server responded with acknowledgment of storing the data. Some when they serialize the content of the store to the hard disk. This transition might require some special attention from you when dealing with records.</p>
<h3 id="why-so-complex"><a class="header" href="#why-so-complex">Why so complex?</a></h3>
<p>This whole machinery allows to reliably describe a state where records are not stored yet and they still retain uniqueness required by the rest of the application. This allows user to work with your software while application still waits for persisting a record. This also allows you to perform the switch to the new id generated by your storage without user ever being interrupted.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../store/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../releases/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../store/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../releases/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
